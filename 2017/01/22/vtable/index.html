<!DOCTYPE html>





<html lang="zh-Hans">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.4.0">
  <link rel="mask-icon" href="/images/logo.svg?v=7.4.0" color="#222">

<link rel="stylesheet" href="/css/main.css?v=7.4.0">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.4.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: 'Copy',
      copy_success: 'Copied',
      copy_failure: 'Copy failed'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="VTable Notes on Multiple Inheritance in GCC C++ Compiler v4.0.1 1. The Basics: Single Inheritance As we discussed in class, single inheritance leads to an object layout with base class data laid out b">
<meta name="keywords" content="vtable">
<meta property="og:type" content="article">
<meta property="og:title" content="vtable">
<meta property="og:url" content="https://yanruibo.github.io/2017/01/22/vtable/index.html">
<meta property="og:site_name" content="Blog">
<meta property="og:description" content="VTable Notes on Multiple Inheritance in GCC C++ Compiler v4.0.1 1. The Basics: Single Inheritance As we discussed in class, single inheritance leads to an object layout with base class data laid out b">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2017-06-03T01:51:17.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="vtable">
<meta name="twitter:description" content="VTable Notes on Multiple Inheritance in GCC C++ Compiler v4.0.1 1. The Basics: Single Inheritance As we discussed in class, single inheritance leads to an object layout with base class data laid out b">
  <link rel="canonical" href="https://yanruibo.github.io/2017/01/22/vtable/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>vtable | Blog</title>
  








  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container use-motion">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">Summary for Comprehensive Learning</p>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
      
      
      
        
        <li class="menu-item menu-item-home">
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-about">
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>About</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-tags">
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-categories">
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-archives">
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger">
        
          <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
      </li>
    
  </ul>

    

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="Searching..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
      <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block post">
    <link itemprop="mainEntityOfPage" href="https://yanruibo.github.io/2017/01/22/vtable/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yrb">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">vtable

          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2017-01-22 21:48:55" itemprop="dateCreated datePublished" datetime="2017-01-22T21:48:55+08:00">2017-01-22</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2017-06-03 09:51:17" itemprop="dateModified" datetime="2017-06-03T09:51:17+08:00">2017-06-03</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/cpp/" itemprop="url" rel="index"><span itemprop="name">cpp</span></a></span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="vtable-notes-on-multiple-inheritance-in-gcc-c-compiler-v4.0.1">VTable Notes on Multiple Inheritance in GCC C++ Compiler v4.0.1</h1>
<h2 id="the-basics-single-inheritance">1. The Basics: Single Inheritance</h2>
<p>As we discussed in class, single inheritance leads to an object layout with base class data laid out before derived class data. So if classes A and B are defined thusly:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">int</span> a;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> :</span> <span class="keyword">public</span> A &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">int</span> b;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>then objects of type B are laid out like this (where "b" is a pointer to such an object):</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">b --&gt; +-----------+</span><br><span class="line">      |     a     |</span><br><span class="line">      +-----------+</span><br><span class="line">      |     b     |</span><br><span class="line">      +-----------+</span><br></pre></td></tr></table></figure>
<p>If you have virtual methods: <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">int</span> a;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">v</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> :</span> <span class="keyword">public</span> A &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">int</span> b;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>then you'll have a vtable pointer as well: <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">                           +-----------------------+</span><br><span class="line">                           |     <span class="number">0</span> (top_offset)    |</span><br><span class="line">                           +-----------------------+</span><br><span class="line">b --&gt; +----------+         | ptr to typeinfo <span class="keyword">for</span> B |</span><br><span class="line">      |  vtable  |-------&gt; +-----------------------+</span><br><span class="line">      +----------+         |         A::v()        |</span><br><span class="line">      |     a    |         +-----------------------+</span><br><span class="line">      +----------+</span><br><span class="line">      |     b    |</span><br><span class="line">      +----------+</span><br></pre></td></tr></table></figure></p>
<p>that is, top_offset and the typeinfo pointer live above the location to which the vtable pointer points.</p>
<h2 id="simple-multiple-inheritance">2. Simple Multiple Inheritance</h2>
<p>Now consider multiple inheritance:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">int</span> a;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">v</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">int</span> b;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">w</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> :</span> <span class="keyword">public</span> A, <span class="keyword">public</span> B &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">int</span> c;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>In this case, objects of type C are laid out like this:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">                           +-----------------------+</span><br><span class="line">                           |     <span class="number">0</span> (top_offset)    |</span><br><span class="line">                           +-----------------------+</span><br><span class="line">c --&gt; +----------+         | ptr to typeinfo <span class="keyword">for</span> C |</span><br><span class="line">      |  vtable  |-------&gt; +-----------------------+</span><br><span class="line">      +----------+         |         A::v()        |</span><br><span class="line">      |     a    |         +-----------------------+</span><br><span class="line">      +----------+         |    <span class="number">-8</span> (top_offset)    |</span><br><span class="line">      |  vtable  |---+     +-----------------------+</span><br><span class="line">      +----------+   |     | ptr to typeinfo <span class="keyword">for</span> C |</span><br><span class="line">      |     b    |   +---&gt; +-----------------------+</span><br><span class="line">      +----------+         |         B::w()        |</span><br><span class="line">      |     c    |         +-----------------------+</span><br><span class="line">      +----------+</span><br></pre></td></tr></table></figure>
<p>...but why? Why two vtables in one? Well, think about type substitution. If I have a pointer-to-C, I can pass it to a function that expects a pointer-to-A or to a function that expects a pointer-to-B. If a function expects a pointer-to-A and I want to pass it the value of my variable c (of type pointer-to-C), I'm already set. Calls to A::v() can be made through the(first) vtable, and the called function can access the member a through the pointer I pass in the same way as it can through any pointer-to-A.</p>
<p>However, if I pass the value of my pointer variable c to a function that expects a pointer-to-B, we also need a subobject of type B in our C to refer it to. This is why we have the second vtable pointer. We can pass the pointer value(c + 8 bytes) to the function that expects a pointer-to-B, and it's all set: it can make calls to B::w() through the (second) vtable pointer, and access the member b through the pointer we pass in the same way as it can through any pointer-to-B.</p>
<p>Note that this "pointer-correction" needs to occur for called methods too. Class C inherits B::w() in this case. When w() is called on through a pointer-to-C, the pointer (which becomes the this pointer inside of w() needs to be adjusted. This is often called this pointer adjustment.</p>
<p>In some cases, the compiler will generate a thunk to fix up the address. Consider the same code as above but this time C overrides B's member function w():</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">int</span> a;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">v</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">int</span> b;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">w</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> :</span> <span class="keyword">public</span> A, <span class="keyword">public</span> B &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">int</span> c;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">w</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>C's object layout and vtable now look like this:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">                           +-----------------------+</span><br><span class="line">                           |     <span class="number">0</span> (top_offset)    |</span><br><span class="line">                           +-----------------------+</span><br><span class="line">c --&gt; +----------+         | ptr to typeinfo <span class="keyword">for</span> C |</span><br><span class="line">      |  vtable  |-------&gt; +-----------------------+</span><br><span class="line">      +----------+         |         A::v()        |</span><br><span class="line">      |     a    |         +-----------------------+</span><br><span class="line">      +----------+         |         C::w()        |</span><br><span class="line">      |  vtable  |---+     +-----------------------+</span><br><span class="line">      +----------+   |     |    <span class="number">-8</span> (top_offset)    |</span><br><span class="line">      |     b    |   |     +-----------------------+</span><br><span class="line">      +----------+   |     | ptr to typeinfo <span class="keyword">for</span> C |</span><br><span class="line">      |     c    |   +---&gt; +-----------------------+</span><br><span class="line">      +----------+         |    thunk to C::w()    |</span><br><span class="line">                           +-----------------------+</span><br></pre></td></tr></table></figure>
<p>Now, when w() is called on an instance of C through a pointer-to-B, the thunk is called. What does the thunk do? Let's disassemble it (here, with gdb):</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x0804860c</span> &lt;_ZThn8_N1C1wEv+<span class="number">0</span>&gt;:  addl   $<span class="number">0xfffffff8</span>,<span class="number">0x4</span>(%esp)</span><br><span class="line"><span class="number">0x08048611</span> &lt;_ZThn8_N1C1wEv+<span class="number">5</span>&gt;:  jmp    <span class="number">0x804853c</span> &lt;_ZN1C1wEv&gt;</span><br></pre></td></tr></table></figure>
<p>So it merely adjusts the this pointer and jumps to C::w(). All is well.</p>
<p>But doesn't the above mean that B's vtable always points to this C::w() thunk? I mean, if we have a pointer-to-B that is legitimately a B (not a C), we don't want to invoke the thunk, right?</p>
<p>Right. The above embedded vtable for B in C is special to the B-in-C case. B's regular vtable is normal and points to B::w() directly.</p>
<h2 id="the-diamond-multiple-copies-of-base-classes-non-virtual-inheritance">3. The Diamond: Multiple Copies of Base Classes (non-virtual inheritance)</h2>
<p>Okay. Now to tackle the really hard stuff. Recall the usual problem of multiple copies of base classes when forming an inheritance diamond:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">int</span> a;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">v</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> :</span> <span class="keyword">public</span> A &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">int</span> b;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">w</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> :</span> <span class="keyword">public</span> A &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">int</span> c;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">x</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span> :</span> <span class="keyword">public</span> B, <span class="keyword">public</span> C &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">int</span> d;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">y</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Note that D inherits from both B and C, and B and C both inherit from A. This means that D has two copies of A in it. The object layout and vtable embedding is what we would expect from the previous sections:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">                           +-----------------------+</span><br><span class="line">                           |     <span class="number">0</span> (top_offset)    |</span><br><span class="line">                           +-----------------------+</span><br><span class="line">d --&gt; +----------+         | ptr to typeinfo <span class="keyword">for</span> D |</span><br><span class="line">      |  vtable  |-------&gt; +-----------------------+</span><br><span class="line">      +----------+         |         A::v()        |</span><br><span class="line">      |     a    |         +-----------------------+</span><br><span class="line">      +----------+         |         B::w()        |</span><br><span class="line">      |     b    |         +-----------------------+</span><br><span class="line">      +----------+         |         D::y()        |</span><br><span class="line">      |  vtable  |---+     +-----------------------+</span><br><span class="line">      +----------+   |     |   <span class="number">-12</span> (top_offset)    |</span><br><span class="line">      |     a    |   |     +-----------------------+</span><br><span class="line">      +----------+   |     | ptr to typeinfo <span class="keyword">for</span> D |</span><br><span class="line">      |     c    |   +---&gt; +-----------------------+</span><br><span class="line">      +----------+         |         A::v()        |</span><br><span class="line">      |     d    |         +-----------------------+</span><br><span class="line">      +----------+         |         C::x()        |</span><br><span class="line">                           +-----------------------+</span><br></pre></td></tr></table></figure>
<p>Of course, we expect A's data (the member a) to exist twice in D's object layout (and it is), and we expect A's virtual member functions to be represented twice in the vtable (and A::v() is indeed there). Okay, nothing new here.</p>
<h2 id="the-diamond-single-copies-of-virtual-bases">4. The Diamond: Single Copies of Virtual Bases</h2>
<p>But what if we apply virtual inheritance? C++ virtual inheritance allows us to specify a diamond hierarchy but be guaranteed only one copy of virtually inherited bases. So let's write our code this way:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">int</span> a;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">v</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> :</span> <span class="keyword">public</span> <span class="keyword">virtual</span> A &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">int</span> b;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">w</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> :</span> <span class="keyword">public</span> <span class="keyword">virtual</span> A &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">int</span> c;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">x</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span> :</span> <span class="keyword">public</span> B, <span class="keyword">public</span> C &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">int</span> d;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">y</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>All of a sudden things get a lot more complicated. If we can only have one copy of A in our representation of D, then we can no longer get away with our "trick" of embedding a C in a D (and embedding a vtable for the C part of D in D's vtable). But how can we handle the usual type substitution if we can't do this?</p>
<p>Let's try to diagram the layout:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">                                   +-----------------------+</span><br><span class="line">                                   |   <span class="number">20</span> (vbase_offset)   |</span><br><span class="line">                                   +-----------------------+</span><br><span class="line">                                   |     <span class="number">0</span> (top_offset)    |</span><br><span class="line">                                   +-----------------------+</span><br><span class="line">                                   | ptr to typeinfo <span class="keyword">for</span> D |</span><br><span class="line">                      +----------&gt; +-----------------------+</span><br><span class="line">d --&gt; +----------+    |            |         B::w()        |</span><br><span class="line">      |  vtable  |----+            +-----------------------+</span><br><span class="line">      +----------+                 |         D::y()        |</span><br><span class="line">      |     b    |                 +-----------------------+</span><br><span class="line">      +----------+                 |   <span class="number">12</span> (vbase_offset)   |</span><br><span class="line">      |  vtable  |---------+       +-----------------------+</span><br><span class="line">      +----------+         |       |    <span class="number">-8</span> (top_offset)    |</span><br><span class="line">      |     c    |         |       +-----------------------+</span><br><span class="line">      +----------+         |       | ptr to typeinfo <span class="keyword">for</span> D |</span><br><span class="line">      |     d    |         +-----&gt; +-----------------------+</span><br><span class="line">      +----------+                 |         C::x()        |</span><br><span class="line">      |  vtable  |----+            +-----------------------+</span><br><span class="line">      +----------+    |            |    <span class="number">0</span> (vbase_offset)   |</span><br><span class="line">      |     a    |    |            +-----------------------+</span><br><span class="line">      +----------+    |            |   <span class="number">-20</span> (top_offset)    |</span><br><span class="line">                      |            +-----------------------+</span><br><span class="line">                      |            | ptr to typeinfo <span class="keyword">for</span> D |</span><br><span class="line">                      +----------&gt; +-----------------------+</span><br><span class="line">                                   |         A::v()        |</span><br><span class="line">                                   +-----------------------+</span><br></pre></td></tr></table></figure>
<p>Okay. So you see that A is now embedded in D in essentially the same way that other bases are. But it's embedded in D rather than inits directly-derived classes.</p>
<h2 id="constructiondestruction-in-the-presence-of-multiple-inheritance">5. Construction/Destruction in the Presence of Multiple Inheritance</h2>
<p>How is the above object constructed in memory when the object itself is constructed? And how do we ensure that a partially-constructed object (and its vtable) are safe for constructors to operate on?</p>
<p>Fortunately, it's all handled very carefully for us. Say we're constructing a new object of type D (through, for example, new D). First, the memory for the object is allocated in the heap and a pointer returned. D's constructor is invoked, but before doing any D-specific construction it call's A's constructor on the object (after adjusting the this pointer, of course!). A's constructor fills in the A part of the D object as if it were an instance of A.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">d --&gt; +----------+</span><br><span class="line">      |          |</span><br><span class="line">      +----------+</span><br><span class="line">      |          |</span><br><span class="line">      +----------+</span><br><span class="line">      |          |</span><br><span class="line">      +----------+</span><br><span class="line">      |          |       +-----------------------+</span><br><span class="line">      +----------+       |     <span class="number">0</span> (top_offset)    |</span><br><span class="line">      |          |       +-----------------------+</span><br><span class="line">      +----------+       | ptr to typeinfo <span class="keyword">for</span> A |</span><br><span class="line">      |  vtable  |-----&gt; +-----------------------+</span><br><span class="line">      +----------+       |         A::v()        |</span><br><span class="line">      |    a     |       +-----------------------+</span><br><span class="line">      +----------+</span><br></pre></td></tr></table></figure>
<p>Control is returned to D's constructor, which invokes B's constructor. (Pointer adjustment isn't needed here.) When B's constructor is done,the object looks like this:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">                                             B-in-D</span><br><span class="line">                          +-----------------------+</span><br><span class="line">                          |   <span class="number">20</span> (vbase_offset)   |</span><br><span class="line">                          +-----------------------+</span><br><span class="line">                          |     <span class="number">0</span> (top_offset)    |</span><br><span class="line">                          +-----------------------+</span><br><span class="line">d --&gt; +----------+        | ptr to typeinfo <span class="keyword">for</span> B |</span><br><span class="line">      |  vtable  |------&gt; +-----------------------+</span><br><span class="line">      +----------+        |         B::w()        |</span><br><span class="line">      |    b     |        +-----------------------+</span><br><span class="line">      +----------+        |    <span class="number">0</span> (vbase_offset)   |</span><br><span class="line">      |          |        +-----------------------+</span><br><span class="line">      +----------+        |   <span class="number">-20</span> (top_offset)    |</span><br><span class="line">      |          |        +-----------------------+</span><br><span class="line">      +----------+        | ptr to typeinfo <span class="keyword">for</span> B |</span><br><span class="line">      |          |   +--&gt; +-----------------------+</span><br><span class="line">      +----------+   |    |         A::v()        |</span><br><span class="line">      |  vtable  |---+    +-----------------------+</span><br><span class="line">      +----------+</span><br><span class="line">      |    a     |</span><br><span class="line">      +----------+</span><br></pre></td></tr></table></figure>
<p>But wait... B's constructor modified the A part of the object by changing it's vtable pointer! How did it know to distinguish this kind of B-in-D from a B-in-something-else (or a standalone B for that matter)? Simple. The virtual table table told it to do this. This structure, abbreviated VTT, is a table of vtables used in construction. In our case, the VTT for D looks like this: <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">                                                                  B-in-D</span><br><span class="line">                                               +-----------------------+</span><br><span class="line">                                               |   <span class="number">20</span> (vbase_offset)   |</span><br><span class="line">            VTT <span class="keyword">for</span> D                          +-----------------------+</span><br><span class="line">+-------------------+                          |     <span class="number">0</span> (top_offset)    |</span><br><span class="line">|    vtable <span class="keyword">for</span> D   |-------------+            +-----------------------+</span><br><span class="line">+-------------------+             |            | ptr to typeinfo <span class="keyword">for</span> B |</span><br><span class="line">| vtable <span class="keyword">for</span> B-in-D |-------------|----------&gt; +-----------------------+</span><br><span class="line">+-------------------+             |            |         B::w()        |</span><br><span class="line">| vtable <span class="keyword">for</span> B-in-D |-------------|--------+   +-----------------------+</span><br><span class="line">+-------------------+             |        |   |    <span class="number">0</span> (vbase_offset)   |</span><br><span class="line">| vtable <span class="keyword">for</span> C-in-D |-------------|-----+  |   +-----------------------+</span><br><span class="line">+-------------------+             |     |  |   |   <span class="number">-20</span> (top_offset)    |</span><br><span class="line">| vtable <span class="keyword">for</span> C-in-D |-------------|--+  |  |   +-----------------------+</span><br><span class="line">+-------------------+             |  |  |  |   | ptr to typeinfo <span class="keyword">for</span> B |</span><br><span class="line">|    vtable <span class="keyword">for</span> D   |----------+  |  |  |  +-&gt; +-----------------------+</span><br><span class="line">+-------------------+          |  |  |  |      |         A::v()        |</span><br><span class="line">|    vtable <span class="keyword">for</span> D   |-------+  |  |  |  |      +-----------------------+</span><br><span class="line">+-------------------+       |  |  |  |  |</span><br><span class="line">                            |  |  |  |  |                         C-in-D</span><br><span class="line">                            |  |  |  |  |      +-----------------------+</span><br><span class="line">                            |  |  |  |  |      |   <span class="number">12</span> (vbase_offset)   |</span><br><span class="line">                            |  |  |  |  |      +-----------------------+</span><br><span class="line">                            |  |  |  |  |      |     <span class="number">0</span> (top_offset)    |</span><br><span class="line">                            |  |  |  |  |      +-----------------------+</span><br><span class="line">                            |  |  |  |  |      | ptr to typeinfo <span class="keyword">for</span> C |</span><br><span class="line">                            |  |  |  |  +----&gt; +-----------------------+</span><br><span class="line">                            |  |  |  |         |         C::x()        |</span><br><span class="line">                            |  |  |  |         +-----------------------+</span><br><span class="line">                            |  |  |  |         |    <span class="number">0</span> (vbase_offset)   |</span><br><span class="line">                            |  |  |  |         +-----------------------+</span><br><span class="line">                            |  |  |  |         |   <span class="number">-12</span> (top_offset)    |</span><br><span class="line">                            |  |  |  |         +-----------------------+</span><br><span class="line">                            |  |  |  |         | ptr to typeinfo <span class="keyword">for</span> C |</span><br><span class="line">                            |  |  |  +-------&gt; +-----------------------+</span><br><span class="line">                            |  |  |            |         A::v()        |</span><br><span class="line">                            |  |  |            +-----------------------+</span><br><span class="line">                            |  |  |</span><br><span class="line">                            |  |  |                                    D</span><br><span class="line">                            |  |  |            +-----------------------+</span><br><span class="line">                            |  |  |            |   <span class="number">20</span> (vbase_offset)   |</span><br><span class="line">                            |  |  |            +-----------------------+</span><br><span class="line">                            |  |  |            |     <span class="number">0</span> (top_offset)    |</span><br><span class="line">                            |  |  |            +-----------------------+</span><br><span class="line">                            |  |  |            | ptr to typeinfo <span class="keyword">for</span> D |</span><br><span class="line">                            |  |  +----------&gt; +-----------------------+</span><br><span class="line">                            |  |               |         B::w()        |</span><br><span class="line">                            |  |               +-----------------------+</span><br><span class="line">                            |  |               |         D::y()        |</span><br><span class="line">                            |  |               +-----------------------+</span><br><span class="line">                            |  |               |   <span class="number">12</span> (vbase_offset)   |</span><br><span class="line">                            |  |               +-----------------------+</span><br><span class="line">                            |  |               |    <span class="number">-8</span> (top_offset)    |</span><br><span class="line">                            |  |               +-----------------------+</span><br><span class="line">                            |  |               | ptr to typeinfo <span class="keyword">for</span> D |</span><br><span class="line">                            +----------------&gt; +-----------------------+</span><br><span class="line">                               |               |         C::x()        |</span><br><span class="line">                               |               +-----------------------+</span><br><span class="line">                               |               |    <span class="number">0</span> (vbase_offset)   |</span><br><span class="line">                               |               +-----------------------+</span><br><span class="line">                               |               |   <span class="number">-20</span> (top_offset)    |</span><br><span class="line">                               |               +-----------------------+</span><br><span class="line">                               |               | ptr to typeinfo <span class="keyword">for</span> D |</span><br><span class="line">                               +-------------&gt; +-----------------------+</span><br><span class="line">                                               |         A::v()        |</span><br><span class="line">                                               +-----------------------+</span><br></pre></td></tr></table></figure></p>
<p>D's constructor passes a pointer into D's VTT to B's constructor (in this case, it passes in the address of the first B-in-D entry). And, indeed,the vtable that was used for the object layout above is a special vtable used just for the construction of B-in-D.</p>
<p>Control is returned to the D constructor, and it calls the C constructor(with a VTT address parameter pointing to the "C-in-D+12" entry). When C's constructor is done with the object it looks like this: <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">                                                                           B-in-D</span><br><span class="line">                                                        +-----------------------+</span><br><span class="line">                                                        |   <span class="number">20</span> (vbase_offset)   |</span><br><span class="line">                                                        +-----------------------+</span><br><span class="line">                                                        |     <span class="number">0</span> (top_offset)    |</span><br><span class="line">                                                        +-----------------------+</span><br><span class="line">                                                        | ptr to typeinfo <span class="keyword">for</span> B |</span><br><span class="line">                    +---------------------------------&gt; +-----------------------+</span><br><span class="line">                    |                                   |         B::w()        |</span><br><span class="line">                    |                                   +-----------------------+</span><br><span class="line">                    |                          C-in-D   |    <span class="number">0</span> (vbase_offset)   |</span><br><span class="line">                    |       +-----------------------+   +-----------------------+</span><br><span class="line">d --&gt; +----------+  |       |   <span class="number">12</span> (vbase_offset)   |   |   <span class="number">-20</span> (top_offset)    |</span><br><span class="line">      |  vtable  |--+       +-----------------------+   +-----------------------+</span><br><span class="line">      +----------+          |     <span class="number">0</span> (top_offset)    |   | ptr to typeinfo <span class="keyword">for</span> B |</span><br><span class="line">      |    b     |          +-----------------------+   +-----------------------+</span><br><span class="line">      +----------+          | ptr to typeinfo <span class="keyword">for</span> C |   |         A::v()        |</span><br><span class="line">      |  vtable  |--------&gt; +-----------------------+   +-----------------------+</span><br><span class="line">      +----------+          |         C::x()        |</span><br><span class="line">      |    c     |          +-----------------------+</span><br><span class="line">      +----------+          |    <span class="number">0</span> (vbase_offset)   |</span><br><span class="line">      |          |          +-----------------------+</span><br><span class="line">      +----------+          |   <span class="number">-12</span> (top_offset)    |</span><br><span class="line">      |  vtable  |--+       +-----------------------+</span><br><span class="line">      +----------+  |       | ptr to typeinfo <span class="keyword">for</span> C |</span><br><span class="line">      |    a     |  +-----&gt; +-----------------------+</span><br><span class="line">      +----------+          |         A::v()        |</span><br><span class="line">                            +-----------------------+</span><br></pre></td></tr></table></figure></p>
<p>As you see, C's constructor again modified the embedded A's vtable pointer.The embedded C and A objects are now using the special construction C-in-D vtable, and the embedded B object is using the special construction B-in-D vtable. Finally, D's constructor finishes the job and we end up with the same diagram as before: <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">                                   +-----------------------+</span><br><span class="line">                                   |   <span class="number">20</span> (vbase_offset)   |</span><br><span class="line">                                   +-----------------------+</span><br><span class="line">                                   |     <span class="number">0</span> (top_offset)    |</span><br><span class="line">                                   +-----------------------+</span><br><span class="line">                                   | ptr to typeinfo <span class="keyword">for</span> D |</span><br><span class="line">                      +----------&gt; +-----------------------+</span><br><span class="line">d --&gt; +----------+    |            |         B::w()        |</span><br><span class="line">      |  vtable  |----+            +-----------------------+</span><br><span class="line">      +----------+                 |         D::y()        |</span><br><span class="line">      |     b    |                 +-----------------------+</span><br><span class="line">      +----------+                 |   <span class="number">12</span> (vbase_offset)   |</span><br><span class="line">      |  vtable  |---------+       +-----------------------+</span><br><span class="line">      +----------+         |       |    <span class="number">-8</span> (top_offset)    |</span><br><span class="line">      |     c    |         |       +-----------------------+</span><br><span class="line">      +----------+         |       | ptr to typeinfo <span class="keyword">for</span> D |</span><br><span class="line">      |     d    |         +-----&gt; +-----------------------+</span><br><span class="line">      +----------+                 |         C::x()        |</span><br><span class="line">      |  vtable  |----+            +-----------------------+</span><br><span class="line">      +----------+    |            |    <span class="number">0</span> (vbase_offset)   |</span><br><span class="line">      |     a    |    |            +-----------------------+</span><br><span class="line">      +----------+    |            |   <span class="number">-20</span> (top_offset)    |</span><br><span class="line">                      |            +-----------------------+</span><br><span class="line">                      |            | ptr to typeinfo <span class="keyword">for</span> D |</span><br><span class="line">                      +----------&gt; +-----------------------+</span><br><span class="line">                                   |         A::v()        |</span><br><span class="line">                                   +-----------------------+</span><br></pre></td></tr></table></figure></p>
<p>Destruction occurs in the same fashion but in reverse. D's destructor is invoked. After the user's destruction code runs, the destructor calls C's destructor and directs it to use the relevant portion of D's VTT. C's destructor manipulates the vtable pointers in the same way it did during construction; that is, the relevant vtable pointers now point into the C-in-D construction vtable. Then it runs the user's destruction code for C and returns control to D's destructor, which next invokes B's destructor with a reference into D's VTT. B's destructor sets up the relevant portions of the object to refer into the B-in-D construction vtable. It runs the user's destruction code for B and returns control to D's destructor, which finally invokes A's destructor. A's destructor changes the vtable for the A portion of the object to refer into the vtable for A. Finally, control returns to D's destructor and destruction of the object is complete. The memory once used by the object is returned to the system.</p>
<p>Now, in fact, the story is somewhat more complicated. Have you ever seen those "in-charge" and "not-in-charge" constructor and destructor specifications in GCC-produced warning and error messages or in GCC-produced binaries? Well, the fact is that there can be two constructor implementations and up to three destructor implementations.</p>
<p>An "in-charge" (or complete object) constructor is one that constructs virtual bases, and a "not-in-charge" (or base object) constructor is one that does not. Consider our above example. If a B is constructed, its constructor needs to call A's constructor to construct it. Similarly, C's constructor needs to construct A. However, if B and C are constructed as part of a construction of a D, their constructors should not construct A, because A is a virtual base and D's constructor will take care of constructing it exactly once for the instance of D. Consider the cases:</p>
<p>If you do a new A, A's "in-charge" constructor is invoked to construct A. When you do a new B, B's "in-charge" constructor is invoked. It will call the "not-in-charge" constructor for A.</p>
<p>new C is similar to new B.</p>
<p>A new D invokes D's "in-charge" constructor. We walked through this example. D's "in-charge" constructor calls the"not-in-charge" versions of A's, B's, and C's constructors (in thatorder).</p>
<p>An "in-charge" destructor is the analogue of an "in-charge"constructor---it takes charge of destructing virtual bases. Similarly,a "not-in-charge" destructor is generated. But there's a third one as well. An "in-charge deleting" destructor is one that deallocates the storage as well as destructing the object. So when is one called in preference to the other?</p>
<p>Well, there are two kinds of objects that can be destructed---those allocated on the stack, and those allocated in the heap. Consider this code (given our diamond hierarchy with virtual-inheritance from before): <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">D d;            <span class="comment">// allocates a D on the stack and constructs it</span></span><br><span class="line">D *pd = <span class="keyword">new</span> D;  <span class="comment">// allocates a D in the heap and constructs it</span></span><br><span class="line"><span class="comment">/* ... */</span></span><br><span class="line"><span class="keyword">delete</span> pd;      <span class="comment">// calls "in-charge deleting" destructor for D</span></span><br><span class="line"><span class="keyword">return</span>;         <span class="comment">// calls "in-charge" destructor for stack-allocated D</span></span><br></pre></td></tr></table></figure></p>
<p>We see that the actual delete operator isn't invoked by the code doing the delete, but rather by the in-charge deleting destructor for the object being deleted. Why do it this way? Why not have the caller call the in-charge destructor, then delete the object? Then you'd have only two copies of destructor implementations instead of three...</p>
<p>Well, the compiler could do such a thing, but it would be morecomplicated for other reasons. Consider this code (assuming a virtual destructor,which you always use, right?...right?!?): <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">D *pd = <span class="keyword">new</span> D;  <span class="comment">// allocates a D in the heap and constructs it</span></span><br><span class="line">C *pc = d;      <span class="comment">// we have a pointer-to-C that points to our heap-allocated D</span></span><br><span class="line"><span class="comment">/* ... */</span></span><br><span class="line"><span class="keyword">delete</span> pc;      <span class="comment">// call destructor thunk through vtable, but what about delete?</span></span><br></pre></td></tr></table></figure></p>
<p>If you didn't have an "in-charge deleting" variety of D's destructor, then the delete operation would need to adjust the pointer just like the destructor thunk does. Remember, the C object is embedded in a D, and so our pointer-to-C above is adjusted to point into the middle of our D object.We can't just delete this pointer, since it isn't the pointer that was returned by malloc() when we constructed it.</p>
<p>So, if we didn't have an in-charge deleting destructor, we'd have to have thunks to the delete operator (and represent them in our vtables), or something else similar.</p>
<h2 id="thunks-virtual-and-non-virtual">6. Thunks, Virtual and Non-Virtual</h2>
<p>This section not written yet.</p>
<h2 id="multiple-inheritance-with-virtual-methods-on-one-side">7. Multiple Inheritance with Virtual Methods on One Side</h2>
<p>Okay. One last exercise. What if we have a diamond inheritance hierarchy with virtual inheritance, as before, but only have virtual methods along one side of it? So: <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">int</span> a;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> :</span> <span class="keyword">public</span> <span class="keyword">virtual</span> A &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">int</span> b;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">w</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> :</span> <span class="keyword">public</span> <span class="keyword">virtual</span> A &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">int</span> c;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span> :</span> <span class="keyword">public</span> B, <span class="keyword">public</span> C &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">int</span> d;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">y</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>In this case the object layout is the following: <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">                                   +-----------------------+</span><br><span class="line">                                   |   <span class="number">20</span> (vbase_offset)   |</span><br><span class="line">                                   +-----------------------+</span><br><span class="line">                                   |     <span class="number">0</span> (top_offset)    |</span><br><span class="line">                                   +-----------------------+</span><br><span class="line">                                   | ptr to typeinfo <span class="keyword">for</span> D |</span><br><span class="line">                      +----------&gt; +-----------------------+</span><br><span class="line">d --&gt; +----------+    |            |         B::w()        |</span><br><span class="line">      |  vtable  |----+            +-----------------------+</span><br><span class="line">      +----------+                 |         D::y()        |</span><br><span class="line">      |     b    |                 +-----------------------+</span><br><span class="line">      +----------+                 |   <span class="number">12</span> (vbase_offset)   |</span><br><span class="line">      |  vtable  |---------+       +-----------------------+</span><br><span class="line">      +----------+         |       |    <span class="number">-8</span> (top_offset)    |</span><br><span class="line">      |     c    |         |       +-----------------------+</span><br><span class="line">      +----------+         |       | ptr to typeinfo <span class="keyword">for</span> D |</span><br><span class="line">      |     d    |         +-----&gt; +-----------------------+</span><br><span class="line">      +----------+</span><br><span class="line">      |     a    |</span><br><span class="line">      +----------+</span><br></pre></td></tr></table></figure></p>
<p>So you can see the C subobject, which has no virtual methods, still has a vtable (albeit empty). Indeed, all instances of C have an empty vtable.</p>
<h2 id="reference">8. reference</h2>
<p>http://stackoverflow.com/questions/6258559/what-is-the-vtt-for-a-class http://web.archive.org/web/20120517021435/http://tinydrblog.appspot.com/?p=89001</p>

    </div>

    
    
    
        
      

      <footer class="post-footer">
          
            
          
          <div class="post-tags">
            
              <a href="/tags/vtable/" rel="tag"># vtable</a>
            
          </div>
        

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
              
                <a href="/2016/12/02/algorithm-problems-20161202/" rel="next" title="algorithm problems 20161202">
                  <i class="fa fa-chevron-left"></i> algorithm problems 20161202
                </a>
              
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
              
                <a href="/2018/11/30/strange-things/" rel="prev" title="strange_things">
                  strange_things <i class="fa fa-chevron-right"></i>
                </a>
              
            </div>
          </div>
        
      </footer>
    
  </div>
  
  
  
  </article>

  </div>


          </div>
          

        </div>
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">
        
        
        
        
      

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#vtable-notes-on-multiple-inheritance-in-gcc-c-compiler-v4.0.1"><span class="nav-text">VTable Notes on Multiple Inheritance in GCC C++ Compiler v4.0.1</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#the-basics-single-inheritance"><span class="nav-text">1. The Basics: Single Inheritance</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#simple-multiple-inheritance"><span class="nav-text">2. Simple Multiple Inheritance</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#the-diamond-multiple-copies-of-base-classes-non-virtual-inheritance"><span class="nav-text">3. The Diamond: Multiple Copies of Base Classes (non-virtual inheritance)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#the-diamond-single-copies-of-virtual-bases"><span class="nav-text">4. The Diamond: Single Copies of Virtual Bases</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#constructiondestruction-in-the-presence-of-multiple-inheritance"><span class="nav-text">5. Construction/Destruction in the Presence of Multiple Inheritance</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#thunks-virtual-and-non-virtual"><span class="nav-text">6. Thunks, Virtual and Non-Virtual</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#multiple-inheritance-with-virtual-methods-on-one-side"><span class="nav-text">7. Multiple Inheritance with Virtual Methods on One Side</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#reference"><span class="nav-text">8. reference</span></a></li></ol></li></ol></div>
        
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
      src="/images/avatar.jpg"
      alt="yrb">
  <p class="site-author-name" itemprop="name">yrb</p>
  <div class="site-description" itemprop="description"></div>
</div>
  <nav class="site-state motion-element">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">42</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
          
            <a href="/categories/">
          
        
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">categories</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-tags">
        
          
            <a href="/tags/">
          
        
        <span class="site-state-item-count">47</span>
        <span class="site-state-item-name">tags</span>
        </a>
      </div>
    
  </nav>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yrb</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.9.0</div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme  <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.4.0</div>

        












        
      </div>
    </footer>
  </div>

  


  <script src="/lib/anime.min.js?v=3.1.0"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="/js/utils.js?v=7.4.0"></script><script src="/js/motion.js?v=7.4.0"></script>
<script src="/js/schemes/muse.js?v=7.4.0"></script>
<script src="/js/next-boot.js?v=7.4.0"></script>



  








  <script src="/js/local-search.js?v=7.4.0"></script>














  

  
    
      
<script type="text/x-mathjax-config">

  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$', '$'], ['\\(', '\\)'] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      equationNumbers: {
        autoNumber: 'AMS'
      }
    }
  });

  MathJax.Hub.Register.StartupHook('TeX Jax Ready', function() {
    MathJax.InputJax.TeX.prefilterHooks.Add(function(data) {
      if (data.display) {
        var next = data.script.nextSibling;
        while (next && next.nodeName.toLowerCase() === '#text') {
          next = next.nextSibling;
        }
        if (next && next.nodeName.toLowerCase() === 'br') {
          next.parentNode.removeChild(next);
        }
      }
    });
  });

  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for (i = 0; i < all.length; i += 1) {
      element = document.getElementById(all[i].inputID + '-Frame').parentNode;
      if (element.nodeName.toLowerCase() == 'li') {
        element = element.parentNode;
      }
      element.classList.add('has-jax');
    }
  });
</script>
<script>
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML', () => {
    MathJax.Hub.Typeset();
  }, window.MathJax);
</script><!-- hexo-inject:begin --><!-- hexo-inject:end -->

    
  

  

  

</body>
</html>
